<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="csrf-token" content="<%= form_authenticity_token %>">

  <title>Agriculture Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" />
  <link rel="stylesheet" href="styles.css" />

  <style>
    body {
        margin: 0;
        font-family: Arial, sans-serif;
        background-color: #f4f4f4;
    }

    #three-js-container {
        width: 100%;
        height: 700px;
        background-color: #e0e0e0;
        border: 1px solid #ccc;
    }
  </style>
</head>

<body>
<div id="three-js-container"></div>

<!-- Importação do Three.js, GLTFLoader e OrbitControls -->
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const container = document.getElementById('three-js-container');

        if (container) {
            // Configuração da cena, câmera e renderizador
            const scene = new THREE.Scene();
            const camera = new THREE.PerspectiveCamera(50, container.clientWidth / container.clientHeight, 0.1, 1000);
            const renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize(container.clientWidth, container.clientHeight);
            renderer.setClearColor(0xf4f4f4);
            container.appendChild(renderer.domElement);

            // Adicionar luz ambiente
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.8);
            scene.add(ambientLight);

            // Configurar controles Orbit
            const controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            controls.minDistance = 40;
            controls.maxDistance = 200;
            controls.maxPolarAngle = Math.PI / 2;

            // Função para adicionar marcador
            const addMarker = (position, color = 0xff0000) => {
                const markerGeometry = new THREE.SphereGeometry(1, 16, 16);
                const markerMaterial = new THREE.MeshBasicMaterial({ color });
                const marker = new THREE.Mesh(markerGeometry, markerMaterial);
                marker.position.copy(position);
                scene.add(marker);
            };

            // Função para ajustar a câmera ao modelo
            const adjustCamera = (object) => {
                const boundingBox = new THREE.Box3().setFromObject(object);
                const center = boundingBox.getCenter(new THREE.Vector3());
                const size = boundingBox.getSize(new THREE.Vector3());
                const distance = Math.max(size.x, size.y, size.z) * 1.5; // Ajustado para puxar mais perto

                camera.position.set(center.x + distance / 2.5, center.y + distance / 2.2, center.z + distance / 2.5);
                camera.lookAt(center);
                camera.updateProjectionMatrix();
            };

            // Carregar modelos GLTF
            const loader = new THREE.GLTFLoader();

            // Carregar modelo cenario
            loader.load(
                'cenario/scene.gltf',
                (gltf) => {
                    const cenarioModel = gltf.scene;
                    cenarioModel.scale.set(200, 200, 200);
                    cenarioModel.position.set(0, 0, 0);
                    scene.add(cenarioModel);

                    // Adicionar marcador para o modelo cenario
                    const boundingBox = new THREE.Box3().setFromObject(cenarioModel);
                    const center = boundingBox.getCenter(new THREE.Vector3());
                    addMarker(center, 0x00ff00); // Verde para o cenario

                    // Ajustar a câmera após carregar o primeiro modelo
                    adjustCamera(cenarioModel);

                    // Carregar cenouras separadas
                    loader.load(
                        'cenouras2/scene.gltf',
                        (gltf2) => {
                            const cenourasModel1 = gltf2.scene.clone();
                            cenourasModel1.scale.set(200, 200, 200);
                            cenourasModel1.position.set(58, 0, 57);
                            scene.add(cenourasModel1);

                            const cenourasModel2 = gltf2.scene.clone();
                            cenourasModel2.scale.set(200, 200, 200);
                            cenourasModel2.position.set(58, 0, 0);
                            scene.add(cenourasModel2);

                            const cenourasModel3 = gltf2.scene.clone();
                            cenourasModel3.scale.set(200, 200, 200);
                            cenourasModel3.position.set(0, 0, 0);
                            scene.add(cenourasModel3);

                            const cenourasModel4 = gltf2.scene.clone();
                            cenourasModel4.scale.set(200, 200, 200);
                            cenourasModel4.position.set(-56, 0, 112);
                            scene.add(cenourasModel4);
                        },
                        undefined,
                        (error) => console.error('Erro ao carregar o modelo cenouras2:', error)
                    );

                    // Carregar trigo separado
                    loader.load(
                        'trigo2/scene.gltf',
                        (gltf3) => {
                            const trigoModel1 = gltf3.scene.clone();
                            trigoModel1.scale.set(200, 200, 200);
                            trigoModel1.position.set(0, 0, -2);
                            scene.add(trigoModel1);

                            const trigoModel2 = gltf3.scene.clone();
                            trigoModel2.scale.set(200, 200, 200);
                            trigoModel2.position.set(51, 0, 0);
                            trigoModel2.rotation.y = Math.PI / 2; // Rotacionando em 45 graus no eixo Y
                            scene.add(trigoModel2);
                        },
                        undefined,
                        (error) => console.error('Erro ao carregar o modelo trigo:', error)
                    );
                },
                undefined,
                (error) => console.error('Erro ao carregar o modelo cenario:', error)
            );

            // Atualizar renderizador e câmera ao redimensionar a janela
            window.addEventListener('resize', () => {
                const width = container.clientWidth;
                const height = container.clientHeight;
                camera.aspect = width / height;
                camera.updateProjectionMatrix();
                renderer.setSize(width, height);
                controls.update();
            });

            // Loop de animação
            function animate() {
                requestAnimationFrame(animate);
                controls.update();
                renderer.render(scene, camera);
            }
            animate();
        } else {
            console.error("O contêiner #three-js-container não foi encontrado.");
        }
    });
</script>
</body>
</html>
